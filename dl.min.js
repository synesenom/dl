var DocumentWriter=function(){this._doc={header:"",author:"",elements:{lines:[],circles:[],polygons:[],paths:[]},footer:""};if(this.constructor==DocumentWriter){throw new Error("Cannot instantiate abstract class")}};DocumentWriter.prototype._drawLine=function(t){throw new Error("Abstract method _drawLine is not defined")};DocumentWriter.prototype._drawCircle=function(){throw new Error("Abstract method _drawCircle is not defined")};DocumentWriter.prototype._drawPolygon=function(){throw new Error("Abstract method _drawPolygon is not defined")};DocumentWriter.prototype._drawPath=function(){throw new Error("Abstract method _drawPath is not defined")};DocumentWriter.prototype.make=function(){throw new Error("Abstract method make is not defined")};DocumentWriter.prototype._reduce=function(t){return t?t.trim().replace(/ +/g," ").replace(/\n /g,"\n"):""};DocumentWriter.prototype.author=function(t){if(t)this._doc.author=t;return this};DocumentWriter.prototype.line=function(t, e, r, n){if(t&&"x"in t&&"y"in t&&e&&"x"in e&&"y"in e&&(t.x!=e.x||t.y!=e.y)&&r&&"r"in r&&"g"in r&&"b"in r){this._doc.elements.lines.push({src:t,dst:e,stroke:r,strokeWidth:n&&n>0?n:1})}return this};DocumentWriter.prototype.circle=function(t, e, r, n, o){if(t&&"x"in t&&"y"in t&&e&&e>0){var i=r&&"r"in r&&"g"in r&&"b"in r;var s=n&&"r"in n&&"g"in n&&"b"in n&&o&&o>0;if(i||s){this._doc.elements.circles.push({pos:t,radius:e,fill:i?r:null,stroke:s?n:null,strokeWidth:s?o:null})}}return this};DocumentWriter.prototype.path=function(t, e, r, n, o){if(t&&t.length>1){for(var i=0; i<t.length; i++){if(!t[i]||!("x"in t[i])||!("y"in t[i]))return this}var s=e&&"r"in e&&"g"in e&&"b"in e;var a=r&&"r"in r&&"g"in r&&"b"in r&&n&&n>0;if(s||a){this._doc.elements.paths.push({corners:t,fill:s?e:null,stroke:a?r:null,strokeWidth:a?n:null,closed:o?o:false})}}return this};if(typeof module!="undefined"&&typeof module.exports=="object")module.exports.DocumentWriter=DocumentWriter;if(typeof module!="undefined")var DocumentWriter=require("../src/document_writer").DocumentWriter;var EPS=function(t){DocumentWriter.apply(this,arguments);this.bbox=t;this._doc.header="%!PS-Adobe-2.0 EPSF-2.0";this._doc.footer="%%EOF"};EPS.prototype=Object.create(DocumentWriter.prototype);EPS.prototype.constructor=EPS;EPS.prototype.kw={gs:" gsave ",gr:" grestore ",np:" newpath ",lw:" setlinewidth ",mt:" moveto ",lt:" lineto ",c:" setrgbcolor ",f:" fill ",s:" stroke ",a:" arc ",cp:" closepath "};EPS.prototype._drawLine=function(t){var e=EPS.prototype.kw;var r=e.gs+e.np;r+=t.stroke.r/255+" "+t.stroke.g/255+" "+ +t.stroke.b/255+e.c;r+=t.strokeWidth+e.lw;r+=t.src.x+" "+t.src.y+e.mt+t.dst.x+" "+t.dst.y+e.lt+e.s;r+=e.gr;return this._reduce(r)+"\n"};EPS.prototype._drawCircle=function(t){var e=EPS.prototype.kw;var r=t.pos.x+" "+t.pos.y+" "+t.radius+" 0 360"+e.a;var n=e.gs+e.np;if(!t.stroke||!t.strokeWidth){n+=t.fill.r/255+" "+t.fill.g/255+" "+t.fill.b/255+e.c;n+=r;n+=e.cp+e.f}else if(t.fill==null){n+=t.stroke.r/255+" "+t.stroke.g/255+" "+t.stroke.b/255+e.c;n+=t.strokeWidth+e.lw;n+=r;n+=e.cp+e.s}else{n+=t.fill.r/255+" "+t.fill.g/255+" "+t.fill.b/255+e.c;n+=r;n+=e.cp;n+=e.gs+e.f+e.gr;n+=t.stroke.r/255+" "+t.stroke.g/255+" "+t.stroke.b/255+e.c;n+=t.strokeWidth+e.lw+e.s}n+=e.gr;return this._reduce(n)+"\n"};EPS.prototype._drawPath=function(t){var e=EPS.prototype.kw;var r=t.corners[0].x+" "+t.corners[0].y+e.mt;for(var n=1;n<t.corners.length;n++){r+=t.corners[n].x+" "+t.corners[n].y+e.lt}if(t.closed)r+=e.cp;var o=e.gs+e.np;if(t.stroke==null){o+=t.fill.r/255+" "+t.fill.g/255+" "+t.fill.b/255+e.c;o+=r+e.f}else if(t.fill==null){o+=t.stroke.r/255+" "+t.stroke.g/255+" "+t.stroke.b/255+e.c;o+=t.strokeWidth+e.lw;o+=r+e.s}else{o+=t.fill.r/255+" "+t.fill.g/255+" "+t.fill.b/255+e.c;o+=r+e.gs+e.f+e.gr;o+=t.stroke.r/255+" "+t.stroke.g/255+" "+t.stroke.b/255+e.c;o+=t.strokeWidth+e.lw+e.s}o+=e.gr;return this._reduce(o)+"\n"};EPS.prototype.make=function(){var t=this._doc.header+"\n% Generated by "+this._doc.author+"\n";t+="%%BoundingBox: 0 0 "+this.bbox.width+" "+this.bbox.height+"\n";t+="\n% Lines\n%\n";this._doc.elements.lines.forEach(function(e){t+=EPS.prototype._drawLine(e)});t+="\n% Circles\n%\n";this._doc.elements.circles.forEach(function(e){t+=EPS.prototype._drawCircle(e)});t+="\n% Paths\n%\n";this._doc.elements.paths.forEach(function(e){t+=EPS.prototype._drawPath(e)});t+=this._doc.footer;return this._reduce(t)};if(typeof module!="undefined"&&typeof module.exports=="object")module.exports.EPS=EPS;var PDF=function(t){DocumentWriter.apply(this,arguments);this.bbox=t;this._doc.header="%PDF-1.4";this._doc.footer="%%EOF"};PDF.prototype=Object.create(DocumentWriter.prototype);PDF.prototype.constructor=PDF;PDF.prototype._drawLine=function(t){var e=t.stroke.r/255+" "+t.stroke.g/255+" "+t.stroke.b/255+" rg ";e+=t.src.x+" "+t.src.y+" m "+t.dst.x+" "+t.dst.y+" l s\n";return e};PDF.prototype._drawCircle=function(t){var e=.551915024494*t.radius;var r=t.pos;var n=t.radius;var o=[[r.x+e,r.y+n,r.x+n,r.y+e,r.x+n,r.y],[r.x+n,r.y-e,r.x+e,r.y-n,r.x,r.y-n],[r.x-e,r.y-n,r.x-n,r.y-e,r.x-n,r.y],[r.x-n,r.y+e,r.x-e,r.y+n,r.x,r.y+n]];var i=[r.x,r.y+n].join(" ")+" m ";for(var s=0;s<o.length;s++){i+=o[s].join(" ")+" c "}var a="";if(t.fill!=null){a+=t.fill.r/255+" "+t.fill.g/255+" "+t.fill.b/255+" rg ";a+=i+"F\n"}if(t.stroke!=null){a+=t.stroke.r/255+" "+t.stroke.g/255+" "+t.stroke.b/255+" RG ";a+=i+" "+t.strokeWidth+" w S\n"}return a};PDF.prototype.make=function(){var t="";var e=[];function r(t){var e="0000000000"+t;return e.substr(e.length-10)}function n(){e.push(t.length)}t=this._doc.header+"\n% Generated by "+this._doc.author+"\n\n";t+="% Catalog\n";n();t+="1 0 obj <</Type /Catalog /Pages 2 0 R>>\nendobj\n\n";t+="% Pages\n";n();t+="2 0 obj <</Type /Pages /Kids [3 0 R] /Count 1>>\nendobj\n\n";t+="% First (only) page\n";n();t+="3 0 obj<</Type /Page /Parent 2 0 R /Resources null";t+="/MediaBox [0 0 "+this.bbox.width+" "+this.bbox.height+"] /Contents 4 0 R>>\nendobj\n\n";var o="";this._doc.elements.lines.forEach(function(t){o+=PDF.prototype._drawLine(t)});this._doc.elements.circles.forEach(function(t){o+=PDF.prototype._drawCircle(t)});t+="% Primitives\n";n();t+="4 0 obj\n";t+="<</Length "+o.length+">>\n";t+="stream\n";t+=o;t+="endstream\nendobj\n\n";n();t+="xref\n0 "+e.length+"\n";t+="0000000000 65535 f\n";for(var i=0; i<e.length-1; i++){t+=r(e[i])+" 00000 n\n"}t+="trailer <</Size "+e.length+"/Root 1 0 R>>\nstartxref\n"+e[e.length-1]+"\n";t+=this._doc.footer;return t};var dl={_junk:{content:{},clear:function(){for(var t in this.content){if(this.content.hasOwnProperty(t))this.content[t].remove()}this.content={}}},_getId:function(){var t="";var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(var r=0;r<32;r++)t+=e.charAt(Math.floor(Math.random()*e.length));return t},_getMetrics:function(t,e){var r=t.attr("width");var n=t.attr("height");var o={canvas:{w:r,h:n},scale:{w:1,h:1}};if(e){if(e.width&&e.height){o.canvas.w=e.width;o.scale.w=o.canvas.w/r;o.canvas.h=e.height;o.scale.h=o.canvas.h/n}else if(e.width){o.canvas.w=e.width;o.scale.w=o.canvas.w/r;o.canvas.h=o.scale.w*n;o.scale.h=o.scale.w}else if(e.height){o.canvas.h=e.height;o.scale.h=o.canvas.h/n;o.canvas.w=o.scale.h*r;o.scale.w=o.scale.h}}return o},_getColor:function(t){if(t==null)return null;var e=t.replace(/\s+/g,"");if(e.length==0||e=="")return null;var r,n,o,i;if(e[0]=="#"){switch(e.length){case 4:return!isNaN(r=parseInt(e[1],16))&&!isNaN(n=parseInt(e[2],16))&&!isNaN(o=parseInt(e[3],16))?{r:17*r,g:17*n,b:17*o}:null;case 7:return!isNaN(r=parseInt(e[1]+e[2],16))&&!isNaN(n=parseInt(e[3]+e[4],16))&&!isNaN(o=parseInt(e[5]+e[6],16))?{r:r,g:n,b:o}:null;default:return null}}if(e.substring(0,3)=="rgb"){var s=e.match(/(\d+(\.\d+)?)/g);switch(e[3]){case"(":return!isNaN(r=+s[0])&&!isNaN(n=+s[1])&&!isNaN(o=+s[2])?{r:r,g:n,b:o}:null;break;case"a":return!isNaN(r=+s[0])&&!isNaN(n=+s[1])&&!isNaN(o=+s[2])&&!isNaN(i=+s[3])?{r:r,g:n,b:o,a:i}:null;break;default:return null}}return null},_getElements:function(t,e){var r=d3.select(t);var n=r.attr("height");var o=[];r.selectAll(e).nodes(0).forEach(function(t){var r=d3.select(t);var i=[];if(e=="path"){r.attr("d").substring(1).split("L").forEach(function(t){var e=t.split(",");i.push({x:+e[0],y:n-e[1]})})}else{i=null}var s=r.attr("stroke-width");var a={x:+r.attr("x")?+r.attr("x"):+r.attr("cx"),x1:+r.attr("x1"),x2:+r.attr("x2"),y:+r.attr("y")?n-r.attr("y"):n-r.attr("cy"),y1:n-r.attr("y1"),y2:n-r.attr("y2"),r:+r.attr("r"),width:+r.attr("width"),height:+r.attr("height"),segments:i,fill:dl._getColor(r.attr("fill")?r.attr("fill"):r.style("fill")),stroke:dl._getColor(r.attr("stroke")?r.attr("stroke"):r.style("stroke")),strokeWidth:s!=null?s.replace("px",""):+r.style("stroke-width").replace("px","")};if(a.fill!=null||a.stroke!=null)o.push(a)});return o},_download:function(t,e){var r=document.createElement("a");r.download=e;r.href=t;r.click()},png:function(t,e,r){var n=d3.select(t);var o=this._getMetrics(n,r);var i=this._junk;i.content.div=d3.select("body").append("div");i.content.svg=i.content.div.append("svg").attr("version",1.1).attr("xmlns","http://www.w3.org/2000/svg").attr("width",n.attr("width")).attr("height",n.attr("height")).html(n.html());var s="dl-png-"+this._getId();d3.select("canvas").remove();i.content.canvas=d3.select("body").append("canvas").attr("id",s).attr("width",o.canvas.w).attr("height",o.canvas.h).style("display","none").node(0);var a=i.content.canvas.getContext("2d");a.scale(o.scale.w,o.scale.h);var l=i.content.svg.node().parentNode.innerHTML;var c="data:image/svg+xml;base64,"+btoa(l);var h=new Image;h.onload=function(){a.drawImage(h,0,0);var t=i.content.canvas.toDataURL("image/png");dl._download(t,e);i.clear()};h.src=c},eps:function(t,e,r){var n=d3.select(t);var o=n.attr("width");var i=n.attr("height");var s=new EPS({width:o,height:i}).author("dl version 0.1");if(r!=null&&r!="")s.author(r);this._getElements(t,"line").forEach(function(t){s.line({x:t.x1,y:t.y1},{x:t.x2,y:t.y2},t.stroke,t.strokeWidth)});this._getElements(t,"circle").forEach(function(t){s.circle({x:t.x,y:t.y},t.r,t.fill,t.stroke,t.strokeWidth)});var a="data:application/postscript; charset=utf-8,"+encodeURIComponent(s.make());this._download(a,e)},pdf:function(t,e,r){var n=d3.select(t);var o=n.attr("width");var i=n.attr("height");var s=new PDF({width:o,height:i}).author("dl version 0.1");if(r!=null&&r!="")s.author(r);this._getElements(t,"line").forEach(function(t){s.line({x:t.x1,y:t.y1},{x:t.x2,y:t.y2},t.stroke,t.strokeWidth)});this._getElements(t,"circle").forEach(function(t){s.circle({x:t.x,y:t.y},t.r,t.fill,t.stroke,t.strokeWidth)});var a="data:application/pdf; charset=utf-8,"+encodeURIComponent(s.make());this._download(a,e)},json:function(t,e){var r=d3.select(t);var n={nodes:this._getElements(t,"circle"),links:this._getElements(t,"line")};var o="data:text/json; charset=utf-8,"+encodeURIComponent(JSON.stringify(n,null,2));this._download(o,e)}};if(typeof module!="undefined"&&typeof module.exports=="object")module.exports.dl=dl;