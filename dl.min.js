var DocumentWriter=function(){this._doc={header:"",author:"",primitives:{lines:[],circles:[],polygons:[],paths:[]},footer:""};if(this.constructor==DocumentWriter){throw new Error("Cannot instantiate abstract class")}};DocumentWriter.prototype._drawLine=function(t){throw new Error("Abstract method _drawLine is not defined")};DocumentWriter.prototype._drawCircle=function(){throw new Error("Abstract method _drawCircle is not defined")};DocumentWriter.prototype._drawPolygon=function(){throw new Error("Abstract method _drawPolygon is not defined")};DocumentWriter.prototype._drawPath=function(){throw new Error("Abstract method _drawPath is not defined")};DocumentWriter.prototype.make=function(){throw new Error("Abstract method make is not defined")};DocumentWriter.prototype.author=function(t){this._doc.author=t;return this};DocumentWriter.prototype.line=function(t,r,e,n){if(t!=null&&r!=null&&("x"in t&&"y"in t)&&("x"in r&&"y"in r)&&(t.x!=r.x||t.y!=r.y)&&e!=null&&n>0){this._doc.primitives.lines.push({src:t,dst:r,stroke:e,strokeWidth:n})}return this};DocumentWriter.prototype.circle=function(t,r,e,n,o){if(t!=null&&"x"in t&&"y"in t&&r>0&&(e!=null||n!=null&&o>0)){this._doc.primitives.circles.push({pos:t,radius:r,fill:e,stroke:n,strokeWidth:o})}return this};DocumentWriter.prototype.polygon=function(t,r,e,n){if(t!=null&&t.length>2&&(r!=null||e!=null&&n>0)){this._doc.primitives.polygons.push({corners:t,fill:r,stroke:e,strokeWidth:n})}return this};DocumentWriter.prototype.path=function(t,r,e,n){if(t!=null&&t.length>2&&(r!=null||e!=null)&&(e==null||n>0)){this._doc.primitives.paths.push({segments:t,fill:r,stroke:e,strokeWidth:n})}return this};var EPS=function(t){DocumentWriter.apply(this,arguments);this.bbox=t;this._doc.header="%!PS-Adobe-2.0 EPSF-2.0";this._doc.footer="%%EOF"};EPS.prototype=Object.create(DocumentWriter.prototype);EPS.prototype.constructor=EPS;EPS.prototype.kw={gs:" gsave ",gr:" grestore ",np:" newpath ",lw:" setlinewidth ",mt:" moveto ",lt:" lineto ",c:" setrgbcolor ",f:" fill ",s:" stroke ",a:" arc ",cp:" closepath "};EPS.prototype._drawLine=function(t){var r=EPS.prototype.kw;var e=r.gs+r.np;e+=t.stroke.r/255+" "+t.stroke.g/255+" "+ +t.stroke.b/255+r.c;e+=t.strokeWidth+r.lw;e+=t.src.x+" "+t.src.y+r.mt+t.dst.x+" "+t.dst.y+r.lt+r.s;e+=r.gr+"\n";return e};EPS.prototype._drawCircle=function(t){var r=EPS.prototype.kw;var e=t.pos.x+" "+t.pos.y+" "+t.radius+" 0 360"+r.a;var n=r.gs+r.np;if(t.stroke==null){n+=t.fill.r/255+" "+t.fill.g/255+" "+t.fill.b/255+r.c;n+=e;n+=r.cp+r.f}else if(t.fill==null){n+=t.stroke.r/255+" "+t.stroke.g/255+" "+t.stroke.b/255+r.c;n+=t.strokeWidth+r.lw;n+=e;n+=r.cp+r.s}else{n+=t.fill.r/255+" "+t.fill.g/255+" "+t.fill.b/255+r.c;n+=e;n+=r.cp;n+=r.gs+r.f+r.gr;n+=t.stroke.r/255+" "+t.stroke.g/255+" "+t.stroke.b/255+r.c;n+=t.strokeWidth+r.lw+r.s}n+=r.gr+"\n";return n};EPS.prototype._drawPolygon=function(t){var r=EPS.prototype.kw;var e=r.gs+r.np;var n=t.corners[0].x+" "+t.corners[0].y+r.mt;for(var o=1;o<t.corners.length;o++){n+=t.corners[o].x+" "+t.corners[o].y+r.lt}if(t.stroke==null){e+=t.fill.r/255+" "+t.fill.g/255+" "+t.fill.b/255+r.c;e+=n;e+=r.cp+r.f}else if(t.fill==null){e+=t.stroke.r/255+" "+t.stroke.g/255+" "+t.stroke.b/255+r.c;e+=n;e+=r.cp+r.s}else{e+=t.fill.r/255+" "+t.fill.g/255+" "+t.fill.b/255+r.c;e+=n;e+=r.cp;e+=r.gs+r.f+r.gr;e+=t.stroke.r/255+" "+t.stroke.g/255+" "+t.stroke.b/255+r.c;e+=t.strokeWidth+r.lw+r.s}e+=r.gr+"\n";return e};EPS.prototype._drawPath=function(t){var r=EPS.prototype.kw;var e="\n% Paths\n%\n";e+=r.gs+r.np;e+=t.stroke.r/255+" "+t.stroke.g/255+" "+t.stroke.b/255+r.c;e+=t.strokeWidth+r.lw+r.f;e+=t.segments[0].x+" "+t.segments[0].y+r.mt;for(var n=1;n<t.segments.length;n++){e+=t.segments[n].x+" "+t.segments[n].y+r.lt}e+=r.s+r.gr+"\n";return e};EPS.prototype.make=function(){var t=this._doc.header+"\n% Generated by "+this._doc.author+"\n";t+="%%BoundingBox: 0 0 "+this.bbox.width+" "+this.bbox.height+"\n";t+="\n% Lines\n%\n";this._doc.primitives.lines.forEach(function(r){t+=EPS.prototype._drawLine(r)});t+="\n% Circles\n%\n";this._doc.primitives.circles.forEach(function(r){t+=EPS.prototype._drawCircle(r)});t+="\n% Polygons\n%\n";this._doc.primitives.polygons.forEach(function(r){t+=EPS.prototype._drawPolygon(r)});t+="\n% Paths\n%\n";this._doc.primitives.paths.forEach(function(r){t+=EPS.prototype._drawPath(r)});t+=this._doc.footer;return t.replace(/  +/g," ").replace(/\n /g,"\n")};var PDF=function(t){DocumentWriter.apply(this,arguments);this.bbox=t;this._doc.header="%PDF-1.4";this._doc.footer="%%EOF"};PDF.prototype=Object.create(DocumentWriter.prototype);PDF.prototype.constructor=PDF;PDF.prototype._drawLine=function(t){var r=t.stroke.r/255+" "+t.stroke.g/255+" "+t.stroke.b/255+" rg ";r+=t.src.x+" "+t.src.y+" m "+t.dst.x+" "+t.dst.y+" l s\n";return r};PDF.prototype._drawCircle=function(t){var r=.551915024494*t.radius;var e=t.pos;var n=t.radius;var o=[[e.x+r,e.y+n,e.x+n,e.y+r,e.x+n,e.y],[e.x+n,e.y-r,e.x+r,e.y-n,e.x,e.y-n],[e.x-r,e.y-n,e.x-n,e.y-r,e.x-n,e.y],[e.x-n,e.y+r,e.x-r,e.y+n,e.x,e.y+n]];var i=[e.x,e.y+n].join(" ")+" m ";for(var s=0;s<o.length;s++){i+=o[s].join(" ")+" c "}var a="";if(t.fill!=null){a+=t.fill.r/255+" "+t.fill.g/255+" "+t.fill.b/255+" rg ";a+=i+"F\n"}if(t.stroke!=null){a+=t.stroke.r/255+" "+t.stroke.g/255+" "+t.stroke.b/255+" RG ";a+=i+" "+t.strokeWidth+" w S\n"}return a};PDF.prototype.make=function(){var t="";var r=[];function e(t){var r="0000000000"+t;return r.substr(r.length-10)}function n(){r.push(t.length)}t=this._doc.header+"\n% Generated by "+this._doc.author+"\n\n";t+="% Catalog\n";n();t+="1 0 obj <</Type /Catalog /Pages 2 0 R>>\nendobj\n\n";t+="% Pages\n";n();t+="2 0 obj <</Type /Pages /Kids [3 0 R] /Count 1>>\nendobj\n\n";t+="% First (only) page\n";n();t+="3 0 obj<</Type /Page /Parent 2 0 R /Resources null";t+="/MediaBox [0 0 "+this.bbox.width+" "+this.bbox.height+"] /Contents 4 0 R>>\nendobj\n\n";var o="";this._doc.primitives.lines.forEach(function(t){o+=PDF.prototype._drawLine(t)});this._doc.primitives.circles.forEach(function(t){o+=PDF.prototype._drawCircle(t)});t+="% Primitives\n";n();t+="4 0 obj\n";t+="<</Length "+o.length+">>\n";t+="stream\n";t+=o;t+="endstream\nendobj\n\n";n();t+="xref\n0 "+r.length+"\n";t+="0000000000 65535 f\n";for(var i=0;i<r.length-1;i++){t+=e(r[i])+" 00000 n\n"}t+="trailer <</Size "+r.length+"/Root 1 0 R>>\nstartxref\n"+r[r.length-1]+"\n";t+=this._doc.footer;return t};var dl={_junk:{content:{},clear:function(){for(var t in this.content){if(this.content.hasOwnProperty(t))this.content[t].remove()}this.content={}}},_getId:function(){var t="";var r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(var e=0;e<32;e++)t+=r.charAt(Math.floor(Math.random()*r.length));return t},_getMetrics:function(t,r){var e=t.attr("width");var n=t.attr("height");var o={canvas:{w:e,h:n},scale:{w:1,h:1}};if(r){if(r.width&&r.height){o.canvas.w=r.width;o.scale.w=o.canvas.w/e;o.canvas.h=r.height;o.scale.h=o.canvas.h/n}else if(r.width){o.canvas.w=r.width;o.scale.w=o.canvas.w/e;o.canvas.h=o.scale.w*n;o.scale.h=o.scale.w}else if(r.height){o.canvas.h=r.height;o.scale.h=o.canvas.h/n;o.canvas.w=o.scale.h*e;o.scale.w=o.scale.h}}return o},_getColor:function(t){if(t==null)return null;var r=t.replace(/\s+/g,"");if(r.length==0||r=="")return null;var e,n,o,i;if(r[0]=="#"){switch(r.length){case 4:return!isNaN(e=parseInt(r[1],16))&&!isNaN(n=parseInt(r[2],16))&&!isNaN(o=parseInt(r[3],16))?{r:17*e,g:17*n,b:17*o}:null;case 7:return!isNaN(e=parseInt(r[1]+r[2],16))&&!isNaN(n=parseInt(r[3]+r[4],16))&&!isNaN(o=parseInt(r[5]+r[6],16))?{r:e,g:n,b:o}:null;default:return null}}if(r.substring(0,3)=="rgb"){var s=r.match(/(\d+(\.\d+)?)/g);switch(r[3]){case"(":return!isNaN(e=+s[0])&&!isNaN(n=+s[1])&&!isNaN(o=+s[2])?{r:e,g:n,b:o}:null;break;case"a":return!isNaN(e=+s[0])&&!isNaN(n=+s[1])&&!isNaN(o=+s[2])&&!isNaN(i=+s[3])?{r:e,g:n,b:o,a:i}:null;break;default:return null}}return null},_getElements:function(t,r){var e=d3.select(t);var n=e.attr("height");var o=[];e.selectAll(r).nodes(0).forEach(function(t){var e=d3.select(t);var i=[];if(r=="path"){e.attr("d").substring(1).split("L").forEach(function(t){var r=t.split(",");i.push({x:+r[0],y:n-r[1]})})}else{i=null}var s=e.attr("stroke-width");var a={x:+e.attr("x")?+e.attr("x"):+e.attr("cx"),x1:+e.attr("x1"),x2:+e.attr("x2"),y:+e.attr("y")?n-e.attr("y"):n-e.attr("cy"),y1:n-e.attr("y1"),y2:n-e.attr("y2"),r:+e.attr("r"),width:+e.attr("width"),height:+e.attr("height"),segments:i,fill:dl._getColor(e.attr("fill")?e.attr("fill"):e.style("fill")),stroke:dl._getColor(e.attr("stroke")?e.attr("stroke"):e.style("stroke")),strokeWidth:s!=null?s.replace("px",""):+e.style("stroke-width").replace("px","")};if(a.fill!=null||a.stroke!=null)o.push(a)});return o},_download:function(t,r){var e=document.createElement("a");e.download=r;e.href=t;e.click()},png:function(t,r,e){var n=d3.select(t);var o=this._getMetrics(n,e);var i=this._junk;i.content.div=d3.select("body").append("div");i.content.svg=i.content.div.append("svg").attr("version",1.1).attr("xmlns","http://www.w3.org/2000/svg").attr("width",n.attr("width")).attr("height",n.attr("height")).html(n.html());var s="dl-png-"+this._getId();d3.select("canvas").remove();i.content.canvas=d3.select("body").append("canvas").attr("id",s).attr("width",o.canvas.w).attr("height",o.canvas.h).style("display","none").node(0);var a=i.content.canvas.getContext("2d");a.scale(o.scale.w,o.scale.h);var l=i.content.svg.node().parentNode.innerHTML;var c="data:image/svg+xml;base64,"+btoa(l);var h=new Image;h.onload=function(){a.drawImage(h,0,0);var t=i.content.canvas.toDataURL("image/png");dl._download(t,r);i.clear()};h.src=c},eps:function(t,r,e){var n=d3.select(t);var o=n.attr("width");var i=n.attr("height");var s=new EPS({width:o,height:i}).author("dl version 0.1");if(e!=null&&e!="")s.author(e);this._getElements(t,"line").forEach(function(t){s.line({x:t.x1,y:t.y1},{x:t.x2,y:t.y2},t.stroke,t.strokeWidth)});this._getElements(t,"circle").forEach(function(t){s.circle({x:t.x,y:t.y},t.r,t.fill,t.stroke,t.strokeWidth)});var a="data:application/postscript; charset=utf-8,"+encodeURIComponent(s.make());this._download(a,r)},pdf:function(t,r,e){var n=d3.select(t);var o=n.attr("width");var i=n.attr("height");var s=new PDF({width:o,height:i}).author("dl version 0.1");if(e!=null&&e!="")s.author(e);this._getElements(t,"line").forEach(function(t){s.line({x:t.x1,y:t.y1},{x:t.x2,y:t.y2},t.stroke,t.strokeWidth)});this._getElements(t,"circle").forEach(function(t){s.circle({x:t.x,y:t.y},t.r,t.fill,t.stroke,t.strokeWidth)});var a="data:application/pdf; charset=utf-8,"+encodeURIComponent(s.make());this._download(a,r)},json:function(t,r){var e=d3.select(t);var n={nodes:this._getElements(t,"circle"),links:this._getElements(t,"line")};var o="data:text/json; charset=utf-8,"+encodeURIComponent(JSON.stringify(n,null,2));this._download(o,r)}};if(typeof module!="undefined"&&typeof module.exports=="object")module.exports.dl=dl;