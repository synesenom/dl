var dl={_junk:{},_tmpId:function(){var id="";var chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(var i=0;i<32;i++)id+=chars.charAt(Math.floor(Math.random()*chars.length));return id},_getMetrics:function(svgElem,options){var svgW=svgElem.attr("width");var svgH=svgElem.attr("height");var m={canvas:{w:svgW,h:svgH},scale:{w:1,h:1}};if(options){if(options.width&&options.height){m.canvas.w=options.width;m.scale.w=m.canvas.w/svgW;m.canvas.h=options.height;m.scale.h=m.canvas.h/svgH}else if(options.width){m.canvas.w=options.width;m.scale.w=m.canvas.w/svgW;m.canvas.h=m.scale.w*svgH;m.scale.h=m.scale.w}else if(options.height){m.canvas.h=options.height;m.scale.h=m.canvas.h/svgH;m.canvas.w=scaleH*svgW;m.scale.w=m.scale.h}}return m},_clean:function(){if(this._junk){for(var elem in this._junk){this._junk[elem].remove()}}},png:function(selector,filename,options){var svgElem=d3.select(selector);var metrics=this._getMetrics(svgElem,options);dl._junk.div=d3.select("body").append("div");dl._junk.svg=dl._junk.div.append("svg").attr("version",1.1).attr("xmlns","http://www.w3.org/2000/svg").attr("width",svgElem.attr("width")).attr("height",svgElem.attr("height")).html(svgElem.html());var id="dl-png-"+this._tmpId();d3.select("canvas").remove();dl._junk.canvas=d3.select("body").append("canvas").attr("id",id).attr("width",metrics.canvas.w).attr("height",metrics.canvas.h).style("display","none").node(0);var context=dl._junk.canvas.getContext("2d");context.scale(metrics.scale.w,metrics.scale.h);var html=this._junk.svg.node().parentNode.innerHTML;var imgsrc="data:image/svg+xml;base64,"+btoa(html);var image=new Image;image.onload=function(){context.drawImage(image,0,0);var canvasData=dl._junk.canvas.toDataURL("image/png");var byteString=atob(document.querySelector("#"+id).toDataURL().replace(/^data:image\/(png|jpg);base64,/,""));var ab=new ArrayBuffer(byteString.length);var ia=new Uint8Array(ab);for(var i=0;i<byteString.length;i++)ia[i]=byteString.charCodeAt(i);var dataView=new DataView(ab);var blob=new Blob([dataView],{type:"image/png"});var DOMURL=self.URL||self.webkitURL||self;var newurl=DOMURL.createObjectURL(blob);var a=document.createElement("a");a.download=filename;a.href=canvasData;a.click();dl._clean()};image.src=imgsrc}};